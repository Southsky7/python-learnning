# 	HTTP协议

- URL：Uniform Resource Locator,统一资源定位，即网络地址，类似www.baidu.com

### 使用HTTP协议访问Web

- 输入URL时，Web浏览器从Web服务器端获取文件资源(resource)等信息从而显示出web页面。
- 像这种通过发送请求获取服务器资源的Web浏览器等都可称为客户端(Client)
- Web使用HTTP(HyperText Transfer Protocol,超文本传输协议)作为规范完成从客户端到服务器端一系列运作流程，可以说Web是建立在HTTP协议上通信的

### HTTP的诞生

- CERN(欧洲核子研究组织)的蒂姆伯纳斯李博士提出了一种能让远隔两地的研究者们共享知识的设想，最初设想的基本理念是:借助多文档之间相互关联形成的超文本连成可互相参阅的WWW(World Wide Web,万维网)
- 到今天已提出了3项WWW构建技术，分别是
  - 把SGML(Standard Generalized Markup Language,标准通用标记语言)作为页面的文本标记语言的HTML
  - 作为文档传递协议的HTTP
  - 指定文档所在地址的URL
- 1997年1月公布的HTTP/1.1是目前主流的HTTP协议版本，可见作为Web文档传输协议的HTTP版本几乎没有更新，HTTP/2.0正在制定，但达到较高覆盖率仍需较长时间。
- 当年HTTP出现是为了解决文本传输的难题，由于协议本身十分简单，于是在此基础上设想了很多应用方法并投入了实际使用，现在HTTP协议已经超出了Web这个框架的局限，被运用到了各种场景里。

### 网络基础TCP/IP

- 通常使用的网络是在TCP/IP协议族的基础上运作的，而HTTP属于它内部的一个自己。
- 不同的硬件、操作系统之间的通信都需要一种规则，这种规则称为协议。把与互联网相关联的协议集合起来总称为TCP/IP。

### TCP/IP的分层管理

- TCP/IP协议按层次分为4层:应用层、传输层、网络层和数据链路层。

### 1.应用层

- 应用层决定了向用户提供应用服务时通信的活动。
- TCP/IP协议族内预存了各类通用的应用服务，如FTP(File Transfer Protocol,文件传输协议)、DNS(Domain Name System,域名系统)等。
- HTTP协议也属于应用层。

#### 2.传输层

- 传输层对上层应用层，提供处于网络连接中的两台计算机之间的数据传输。
- 在传输层有两个性质不同的协议：TCP(Transmission Control Protocol,传输控制协议)和UDP(User Data Protocol,用户数据报协议)

#### 3.网络层，又名网络互连层

- 网络层用于处理在网络上流动的数据包，数据包是网络传输的最小数据单位。该层规定了通过怎样的路径(即传输路线)到达对方计算机并把数据包传给对方。
- 与对方计算机之间通过多台计算机或网络设备进行传输时，网络层所起的作用就是在众多的选项内选择一条传输路线。
- IP协议属于该层

#### 4.链路层，又名数据链路层，网络接口层

- 用来处理网络连接的硬件部分，包括控制操作系统、硬件的设备驱动、NIC(NetWork Interface Card,网络适配器，即网卡)及光纤等物理可见部分，硬件上的范畴均在链路层的作用范围之内。

### TCP/IP通信传输流

- ![image-20211020150312043](http://r19kczb6x.hn-bkt.clouddn.com/img/image-20211020150312043.png)

- 利用TCP/IP协议族进行网络通信时，会通过分层顺序与对方进行通信，发送端从应用层往下走，接收端则从链路层往上走。
- 以HTTP举例，作为发送端的客户端在应用层(HTTP协议)发出一个想看某个Web页面的HTTP请求，为了传输方便，在传输层(TCP协议)把应用层处收到的数据(HTTP请求报文)进行分割，并在各个报文上打上标记序号及端口号后发送给网络层。在网络层(IP协议)增加作为通信目的地的MAC地址后转发给链路层，这样发送网络的通信请求就准备齐全了。
- 接收端的服务器在链路层收到数据，按序向上发送，当传输到应用层，才能算真正接收到由客户端发送过来的HTTP请求。
- 发送端在层层传输时每经过一层必定会被打上一个该层所属的首部信息，反之，接收端会逐层消去信息。
- 这种把数据信息包装起来的做法叫做封装。

### 与HTTP关系密切的协议:IP、TCP和DNS

#### 1.负责传输的IP协议

- 按层次分，IP(Internet Protocol)网际协议位于网络层，IP与IP地址不同，IP是一种协议的名称。
- IP协议的作用是把各种数据包传送给对方，而要确保确实传送到对方需要满足各类条件，其中两个最重要的条件是IP地址和MAC地址(Media Access Control Address，媒体存取控制地址)。
- MAC地址，直译为媒体存取控制地址，也称为局域网地址(LAN Address),MAC位址，以太网地址(Ethernet Address)或物理地址(Physical Address),它是一个用来确认网络设备位置的位址。在OSI模型中，第三层网络负责IP地址，第二层数据链路层负责MAC位址.MAC地址用于在网络中唯一标示一个网卡，一台设备，每个网卡需要并会有唯一的MAC地址。
- IP地址指明了节点被分配到的地址，MAC地址是网卡所属的固定地址，IP地址可与MAC地址进行配对，IP地址可变换，MAC地址基本不变。

##### 使用ARP协议凭借MAC地址进行通信

- IP间的通信依赖MAC地址，网络上通信双方在同一局域网(LAN)情况很少，通常是经过多台计算机和网络设备中转才能连接到对方，在中转是会利用下一站中专设备的MAC地址来搜索下一个中转目标，这时会采用ARP协议(Address Resolution Protocol，地址解析协议)，根据通信方的IP地址就可以反查出对应的MAC地址。
- 在到达通信目标前的中转过程中，那些计算机和路由器等网络设备只能获悉很粗略的传输路线，这种机制称为路由选择。

#### 2.确保可靠性的TCP协议

- TCP位于传输层，提供可靠的字节流服务，字节流服务(Byte Stream Service)是指为了方便运输将大块数据分割成以报文段(segment)为单位的数据包进行管理，可靠的传输服务指能把数据准确可靠的传给对方，即TCP协议是为了更容易传送大数据才把数据分割，且TCP协议能够确认数据最终是否送达到对方。

- ##### 确保数据能到达目标

  - 为了准确无误的将数据送达目标处，TCP协议采用了三次握手(three-way handshaking)策略，用TCP协议把数据包送出去后，TCP会向对方确认是否成功送达，握手过程中使用了TCP的标志(flag)-SYN(synchronize)和ACK(acknowledgement)。
  - 发送端先发送一个带SYN标志的数据包给对方，接收端收到后会回传一个带有SYN/ACK标志的数据包以示传达确认信息，最后发送端再回传一个带ACK标志的数据包代表握手结束。
  - 若在握手过程中某个阶段莫名中断，TCP协议会在此以相同顺序发送数据包。

#### 3.负责域名解析的DNS服务

- DNS(Domain Name System,域名系统)服务是和HTTP协议一样位于应用层的协议，它提供域名到IP地址之间的解析服务。
- 计算机既可以被赋予IP地址，也可以被赋予主机名和域名。
- 用户通常使用主机名或域名访问对方计算机，因为IP地址纯数字不好记忆，但计算机更擅长处理数字，因此DNS诞生，DNS协议通过域名查找IP地址或逆向服务。

### 统一资源标识符URI  Uniform Resource Identifier

- Uniform:规定统一的格式可方便处理多种不同类型的资源而不同根据上下文环境来识别资源指定的访问方式且加入新增的协议方案(如http、ftp)也更容易。

- Resource:资源的定义是可标识的任何东西，如文档文件，图像，服务

- Identifier:可标识的对象，即标识符。

- 综上，URI是由某个协议方案表示的资源的定位标识符，协议方案指访问资源所使用的协议类型名称

- 采用HTTP协议时，协议方案就是HTTP，标准URI协议方案有30种，如ftp、telnet、net、mailto

- URI用字符串标识某一资源而URL表示资源的地点，so URL是URI的子集/

- 常见URI:

  - http://www.baidu.com
  - ftp://ftp.is.co.za/rfc/rfc1808.txt
  - telnet://192.0.2.16:80/

  ![image-20211020165826356](http://r19kczb6x.hn-bkt.clouddn.com/img/image-20211020165826356.png)

- 登录信息(认证)：指定用户名和密码作为从服务器端获取资源时必要的登录信息(身份认证),可选项
- 服务器地址:使用绝对URI必须指定待访问的服务器地址。
- 服务器端口号:指定服务器连接的网络端口号，用户省略则自动使用默认端口号
- 带层次的文件路径:指定服务器上的文件路径来定位特指的资源
- 查询字符串:针对已指定的文件路径内的资源，可以使用查询字符串传入任意参数，可选项。
- 片段标识符:使用片段标识符通常可标记处已获取资源种的子资源，可选项

## HTTP基础

- HTTP协议用于客户端与服务器之间的通信
- HTTP协议规定请求从客户端发出，最后服务器响应该请求且返回。 
- ![image-20211020175445263](http://r19kczb6x.hn-bkt.clouddn.com/img/image-20211020175445263.png)

#### 发送请求:

- GET表示请求访问服务器的类型，称为方法，字符串指明了请求访问的资源对象，也叫请求URI(request-URI),最后的HTTP/1.1,用来提示客户端使用的HTTP协议功能。
- 请求报文是由请求方法、请求URI、协议版本、可选的请求首部字段和内容实体构成。

#### 响应请求：

- 开头的HTTP/1.1表示版本，200 OK表示请求的处理结果的状态码(status code)和原因短语(reason-phrase).下一行是创建响应的日期时间，以一个空行分隔，之后内容称为资源实体的主体。
- 响应报文由协议版本、状态码(表示成功或失败的数字代码)、用以解释状态码的原因短语、可选的响应首部字段以及实体主体构成。



- HTTP是一种不保存状态，即无状态stateless协议，其自身不对请求和响应之间的通信状态进行保存。
- 为了保存用户状态，引入了Cookie技术用于管理状态。
- HTTP协议使用URI定位互联网上的资源，客户端发送请求时，URI需要将作为请求报文种的请求URI包含在内。
- 对服务器本身发起请求时可用*代替请求URI

### 告知服务器意图的HTTP方法

#### 1.GET:获取资源

- 用于请求访问已被URI识别的资源，指定的资源经服务器端解析后返回响应内容。 

#### 2.POST:传输实体主体

- GET方法也可以传输主体，但一般用POST方法，POST方法主要是传输，不是获取响应。

#### 3.PUT:传输文件

- 妖气再请求报文主题包含文件内容然后保存在请求URI指定位置。但由于PUT方法不带验证机制，有安全问题，一般Web网站不用此方法。

#### 4.HEAD:获得报文首部

- 与GET方法一样，但不返回主体部分，用于确认URI的有效性及资源更新的日期时间。

#### 5.DELETE:删除文件

- 与PUT相反，用于删除请求URI指定的资源，但也不带验证机制，所以一般不用。

#### 6.OPTIONS:询问支持的方法

- 用于查询对请求URI指定的资源支持的方法。

#### 7.TRACE:追踪路径

- 让Web服务器将之前的请求通信返回给客户端的方法
- 易引发XST(Cross-Site Tracing，跨站追踪)攻击，不怎么用。

#### 8.CONNECT：要求用隧道协议连接代理

- 此方法要求与代理服务器通信时建立隧道用于TCP通信，主要使用SSL(Secure Sockets Layer,安全套接层)和TLS(Transport Layer Security,传输层安全)协议把通信内容加密后经网络隧道传输。
- 格式：CONNECT 代理服务器名:端口号 HTTP版本

### 持久连接

- HTTP初始版本每进行一次HTTP通信就要断开一次TCP连接。
- 持久连接特点是只要一段未提出断开连接就保持TCP连接状态。减少了TCP重复建立和断开的额外开销，减轻了服务器端的负载，使HTTP请求和响应更早结束，Web显示时间提高。
- 持久连接使管线化称为可能，最初发送请求后得到响应才能发送下一个请求，管线化之后可用并行发送多个请求。

### Cookie

- Cookie技术通过在请求和响应报文种写入Cookie信息来控制客户端状态。
- Cookie根据响应报文中的Set-Cookie首部字段信息，通知客户端保存Cookie，当下次客户端在往服务器发送请求时，客户端会自动在请求报文中添加Cookie值，服务器通过对比Cookie值就知道从哪个客户端发来信息，从而得到之前的状态信息。

## HTTP报文

![image-20211020224848478](http://r19kczb6x.hn-bkt.clouddn.com/img/image-20211020224848478.png)

![image-20211020224900773](http://r19kczb6x.hn-bkt.clouddn.com/img/image-20211020224900773.png)

- 用于HTTP协议交互的信息被称为HTTP报文，分为请求报文和响应报文。其本身是有多行数据构成的字符串文本。

- 不一定要有报文主体。

- #### 首部内容组成

  - 请求行：包含用于请求的方法，请求URI和HTTP版本
  - 状态行：包含表明响应结果的状态码，原因短语和HTTP版本
  - 首部字段：包含请求和响应的各种条件和属性的各类首部。首部有4种:通用首部、请求首部、响应首部和实体首部
  - 其他，如HTTP的RFC里未定义的首部(Cookie等)

#### 编码提升传输速率

- HTTP在传输数据时可以按数据样貌直接传输也可以在传输过程中通过编码提升传输速率，但编码由计算机完成因此会消耗更多CPU资源。
- 报文message：HTTP通信的基本单位，由8位组字节流(octet sequence,octet为8个比特)组成，通过HTTP通信传输
- 实体entity:作为请求或响应的有效载荷数据被传输，其内容由实体首部和实体主体组成。
- HTTP报文的主体用于传输请求或响应的实体主体，通常二者相等，仅当传输时进行编码操作时，实体主体内容变化，才与报文主体产生差异。

#### 压缩传输的内容编码

- 内容编码指应用在实体内容上的编码格式，并保持实体信息原样压缩，编码后的实体由客户端接收并负责解码。
- 常见内容编码：
  - gzip(GNU zip)
  - compress(UNIX系统的标准压缩)
  - deflate(zlib)
  - identify(不进行编码)

#### 分块传输编码

- 传输大容量数据时通过把数据分割成多块，能够让浏览器逐步显示页面，这种把实体主体分块的功能称为分块传输编码Chunked Transfer Coding
- 分块传输编码把实体主体分成多个部分，每块都用十六进制标记块的大小，实体主体的最后一块用0(CR+LF)来标记。实体主体由客户端负责解码，恢复到编码前的实体主体。

### MIME

- 发送邮件时可以添加多份附件是因为采用了MIME机制，Multipurpose Internet Mail Extensions,多用途因特网邮件扩展，它允许邮件处理文本、图片、视频等多个不同类型的数据，MIME扩展中使用了称为多部份对象集合(Multipart)的方法来容纳多份不同类型的数据。
- HTTP协议也采纳了多部分对象集合，发送的一份报文主体内可含有多类型实体，通常是在图片或文本文件等上传时使用。
- 多部份对象集合包含的对象：
  - multipart/form-data:在Web表单文件上传时使用
  - multipart/byteranges:状态码206(Partial Conent,部分内容)响应报文包含多个范围的内容时使用。
  - HTTP报文中使用多部份对象集合时，需要在首部字段里加上Content-type。
  - 使用boundary字符串来划分多部份对象集合指明的各类实体。在boundary字符串指定的各个实体起始行之前插入--(如--AaB03x)标记，在最后插入--如(--AaB03x--)作为结束
  - 多部份集合对象每个部分类型都可以含有首部字段且可以在某个部分嵌套使用多部分对象集合。

### 获取部分内容的范围请求

- 以前下载过程中若中断就需要重新下载，为了解决此问题，需要一种可恢复的机制，即从中断处恢复下载。
- 要实现该功能需要指定下载的实体范围，指定范围发送的请求叫做范围请求。
- 对一份10000字节大小的资源，使用范围请求只能请求5001~1000字节内的资源。
- 执行范围请求时，使用首部字段Range来指定资源的byte范围。

- 5001~10000字节：Range:bytes = 5001 - 10000       5001字节之后全部的:Range:bytes:5001 - 
- 多重范围，如开始到3000字节和5000~7000字节：Range:bytes = 0 - 3000,5000-7000
- 针对范围请求，响应返回状态码为206 Partial Conent的响应报文且对于多重范围的范围请求，响应会在首部字段Conent-Type标明multipart/byteranges后返回响应报文。若服务器无法响应范围请求，则会返回状态码200 OK和完整实体内容。

### 内容协商

- 同一个Web网站可能存在多份内容相同的页面，如中文和英文页面，内容相同却语言不同，当浏览器默认语言为中文则浏览器对应显示中文，这种机制叫内容协商
- 内容协商机制是指客户端和服务器端就响应的资源内容进行交涉然后提供客户端最适合的资源，内容协商以语言、字符串、编码方式等基准判断资源。
- 常见的首部字段中的判断基准:
  - Accept
  - Accept-Charset
  - Accept-Encoding
  - Accept-Language
  - Content-Language
- 内容协商有3种类型：
  - 服务器驱动协商 Server -driven Negotiation,以服务器端进行内容协商，以请求的首部字段为参考，在服务器端自动处理，但对用户来算根据浏览器发送的信息不一定能筛选出最优内容。
  - 客户端驱动协商 Agent-driven Negotiation，由客户端进行内容协商的方式，用户从浏览器显示的可选项列表手动选择，也可以用JavaScript脚本在Web页面自动进行上述选择，如按OS的类型或浏览器类型自行切换成PC页面或手机页面
  - 透明协商Transport Negotiation，两者相结合。

# 状态码

- 状态码职责是当客户端向服务器发送请求时，描述返回的请求结果，借助它用户可以知道服务器是正常处理了请求还是出现了错误。

- 状态码由3位数字和原因短语组成，如200 OK,数字第一位指定了响应类别，后两位无分类。

  |      | 类别                           | 原因短语                   |
  | ---- | ------------------------------ | -------------------------- |
  | 1XX  | Informtional,信息性状态码      | 接收的请求正在处理         |
  | 2XX  | Success,成功状态码             | 请求正常处理完毕           |
  | 3XX  | Redirection,重定向状态码       | 需要进行附加操作以完成请求 |
  | 4XX  | Client Error,客户端错误状态码  | 服务器无法处理请求         |
  | 5XX  | Server Error，服务器错误状态码 | 服务器处理请求出错         |

  

