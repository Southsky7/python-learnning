# 网络是怎样连接的

### 旅程总览

1. 当我们输入URL时，浏览器按照一定规则分析URL含义并根据含义生成请求消息再发给Web服务器，浏览器并不亲自负责数据传送，它将委托操作系统中的网络控制软件将消息发送给服务器，第一章的内容就是浏览器将数据委托出去之前的过程。

2. 协议栈(即刚才提到的网络控制软件)将从浏览器收到的消息打包再加上目的地址等地址信息(协议栈还有其他功能，如发生通信错误时重新发送包，调节数据发送的速率，可将其当作帮助寄信的秘书)，然后协议栈将包交给网卡(负责以太网或无线网络通信的硬件)，网卡将包转换成电信号且通过网线发送出去，这样包就进入网络中了。

3. 客户端计算机可通过家庭、公司进入互联网或单独接入互联网。假设客户端计算机连接到家庭或公司局域网中，再通过ADSL和光纤到户(FTTH)等宽带线路接入互联网。此时网卡发送的包会经过交换机等设备到达用来接入互联网的路由器，路由器后面就是互联网。

4. 接着数据从接入网路的路由器出发进入了互联网内部。互联网入口线路称为接入网，通常可用电话线、ISDN、ADSL、有线电视、光线、专线等多种通信线路接入互联网，这些统称为接入网。接入网连接到签约的网络运营商，并接入被称为接入点(Point of Presence,PoP)的设备。

   1. 接入点的实体是专为运营商设计的路由器，可列解为离家最近的邮局。
   2. 接入点后面就是互联网的骨干部分了。骨干网中存在很多运营商和大量路由器，它们相互连接形成巨大的网，网络包就在其中经过若干路由器的接力最终被发送到目标Web服务器上。
   3. 无论在互联网中还是家庭公司的局域网中，包都是以相同方式运输的，这是互联网的一大特征。
   4. 运营商使用的路由器与家用路由器不同，它是一种可连接几十根网线的高速大型路由器，互联网骨干部分存在大量这种路由器，它们以复杂的形式连接起来，网络包就在这种路由器中穿行。
   5. 家庭和公司局域网一般用以太网线连接，而互联网中除了以太网连接，还有电话技术和光通信技术来传送网络包。

5. 通过骨干网后网络包最终到达了Web服务器所在局域网，接着会遇到防火墙，检查完后可能会遇到缓存服务器，若访问的网页数据在服务器中能找到，那么就不必劳烦Web服务器，直接从缓存服务器读取数据。大型网站可能还会匹配将消息分布到多台Web服务器上的负载均衡器，还可能使用通过分布在整个互联网中的缓存服务器来分发内容的服务，经过这些机制，网络包才到达Web服务器。

6. 网络包到达Web服务器后，数据被解包且还原为原始的请求消息，然后交给Web服务器程序，这个操作也由协议栈完成。然后Web服务器分析请求消息的含义，按照其指示将数据装入响应消息并发给客户端。响应消息回到客户端的过程与之前介绍的过程恰好相反。当响应道道客户端后，浏览器会从中读取出网页的数据并显示在屏幕上。

7. ### bingo!

# 1.浏览器生成消息

- 输入URL后，浏览器对其解析然后根据其含义生成请求消息，通过请求消息将用户需要的数据告知服务器。浏览器如何解析？请求消息实际长什么样？
- 请求消息生成后，浏览器委托操作系统向Web服务器发送请求，但浏览器必须告诉操作系统接收方的IP地址，因此浏览器必须先查出Web服务器的IP地址，网址中只有Web服务器域名，浏览器需向DNS服务器查询域名对应的IP地址。浏览器如何进行这一操作？
- 全球有上万台DNS服务器，它们相互接力才能完成IP地址查询。它们如何接力?
- 查到IP地址后，浏览器便可委托操作系统发送給Web服务器。如何委托？

### 1.1 生成HTTP请求消息

- URL除了http:，还有ftp:,file:,mailto:开头的，之所以有各种各样的URL是因为浏览器除了访问Web浏览器，还可以用来在FTP服务器(File Transfer Protocol,文件传输协议，使用FTP协议来传送文件的程序也叫做FTP)上下载和上传文件，也具备电子邮件客户端的功能，即浏览器是一个具备多种客户端功能的综合性客户端软件，因此它需要信息来判断使用哪种功能来访问相应数据。

#### 1.1.1 解析URL

- URL格式:http:  +  //   +  Web服务器名字  + /  +  目录名   +  /  + ....  +   文件名
- http://www.lab.glasscom.com/dir1/file1.html

#### 1.1.2 省略文件名的情况

1. 以/结尾的URL: http://www.lab.glasscom.com/dir/,以/结尾表示dir后面文件名被省略了，根据URL规则，文件名可以这样省略，此时会访问服务器实现设置好的默认文件名，大多是indexhtml和default.htm之类的文件名
2. 省略目录名:http://www.lab.glasscom.com/,此时URL也以/结尾，此时也是访问/index.html或/default.htm之类的文件。
3. /表示目录层级中最顶层的根目录
4. http://www.lab.glasscom.com,此时甚至省略了根目录/，此时访问根目录下事先设置的默认文件
5. http://www.lab.glasscom.com/whatisthis,由于末尾没有/，此时习惯性将whatisthis理解为文件名，但实际上很多人经常会把目录末尾的/也省略了，因此不应该总是把whatisthis当作文件名处理，正确处理方式是若Web服务器上存在名为whatisthis的文件，则当作文件名处理，若存在名为whatisthis的目录，则当作目录处理。

#### 1.1.3 http基本思路

- 解析完URL之后，就知道访问的目标在哪里了，接下来浏览器会使用HTTP协议来访问Web服务器。
- HTTP协议基本思路:其定义了客户端和服务器之间交互的消息内容和步骤。
  - 首先客户端会向服务器发送请求消息，包含内容是‘对什么’和‘进行什么操作’，‘对什么’称为URI(Uniform Resource Identifier,统一资源标识符)，URI内容是一个存放网页数据的文件名或CGI程序(对Web服务器程序调用其他程序的规则所作的定义就是CGI)的文件名，也可以直接使用http:开头的URL来作为URI，即可以写各种访问目标，而访问目标统称为URI。
  - ‘进行什么操作’的部分方法，表示让Web服务器完成怎样的操作，如读取URI表示的数据，将客户端输入的数据发送给URI表示程序等。GET、POST、DELETE
  - Web服务器收到请求消息后对其中内容进行解析，通过URI和方法判断对什么进行什么操作，在响应消息开头有一个状态码来表示操作执行结果成功还是错误。

#### 1.1.4 生成HTTP请求消息

- 对URL解析后，浏览器确定了Web服务器和文件名，接下来根据这些信息生成HTTP请求消息。
- Web服务器收到请求消息后会返回响应消息，浏览器接收到响应消息后会将数据提取出来并显示在屏幕上，我们就能看到网页的样子了，若网页内容仅有文字，那么到这里就结束了，若网页中还有图片等资源，则还有一些步骤
- 当网页中包含图片时，会在网页中相应位置嵌入表示图片文件的标签的控制信息，浏览器在显示文字时搜索相应标签，遇到图片相关信息时会在屏幕上留出来用来显示图片的空间，然后再次访问Web服务器，按照标签中指定的文件名向Web服务器请求获取相应的图片并且显示在预留的空间中。
- 每条请求消息只能写1个URI，所以每次只能获取1个文件，若需获取多个文件则需对每个文件单独发送1条请求，如1个网页包含3张图片，那么获取网页加上获取图片，共需向Web服务器发送4条请求。

### 1.2 向DNS服务器查询Web服务器的IP地址

#### 1.2.1 ip地址基本消息

- 生成HTTP消息后，接下来需要委托操作系统将消息发送给Web服务器，尽管浏览器能解析网址，但它不具备将消息发送到网络中的功能，这需要委托操作系统来实现，进行此操作之前需要查询网址中服务器域名对应的IP地址，因此生成HTTP消息之后下一个步骤就是根据域名查询IP地址。
- IP地址:互联网和公司内部的局域网都是基于TCP/IP思路来涉及的，TCP/IP的结构是由一些小的子网通过路由器连接起来组成一个大的网络，子网可理解为用集线器连接起来的几台计算机，将它看作一个单位，称为子网，将子网提供路由器连接便形成了网络。
- 网络中所有设备都会被分配一个地址，相当于现实中某条路中的‘某某号某某室’，号对应的号码是分配给整个子网的，室对应的号码是分配给子网中的计算机的，号称为网络号，室称为主机号，这个地址的整体就是IP地址，通过IP地址便可判断出访问对象服务器的位置从而将消息发送到服务器。发出的消息首先经过子网中的集线器，转发到距离发送者最近的路由器上，不断重复，最终消息就被传送到了目的地。
- IP地址是一串32比特的数字，按照8比特(1个字节)分为4组，eg:   10.11.12.13,但仅有这串数字无法区分哪部分是网络号或主机号，因此需要附加消息表示IP地址的内部结构，附加消息就是子网掩码，是一串与IP地址长度相同的32比特数字。
- IP地址与子网掩码:
  - 十进制表示法:10.11.12.13/255.255.255.0
  - 比特表示法:00001010.00000001.00000010.00000011/11111111.11111111.111111111.00000000.
  - 子网掩码为1的部分表示网络号，0的部分表示主机号。
  - 需要注意的是主机号的比特全为0或全为1时，如10.11.12.0(没错，就是你这个0，表示全为0！)/255.255.255.0，分别代表2种特殊的含义，主机号全为0代表整个子网而不是子网中的某台设备，主机号部分全为1代表向子网所有设备发送包，即广播。

#### 1.2.2 域名和IP地址并用的理由

- 为什么在网址中不写服务器名字，直接写IP地址:记住一串数字比较难，相比IP地址服务器名称更好记
- 为什么干脆不用IP地址，直接用名称:IP地址仅有4个字节，域名最短也要几十个字节，最长甚至达到255个字节，会增加路由器负担，传送数据会更慢。
- 于是现实中采用的方案是让人来使用名称，让路由器使用IP地址，为填补二者之间的障碍，需要一个机制能通过IP地址查询名称或通过IP地址查询名称，这个机制就是DNS!!!

#### 1.2.3 Socket库:查询IP地址

- 查询IP地址方法很简单，询问最近的DNS服务器'www.baidu.com的IP是什么'，DNS服务器就会回答‘该服务器IP地址为。。。’，但需要弄清楚浏览器是怎样向DNS服务器发出查询的。
- 对于DNS服务器，我们计算机上一定有相应的DNS客户端，称为解析器，通过DNS查询IP地址的操作称为域名解析，因此负责此操作的就叫解析器。解析器实际上是一段程序，包含在操作系统的Socket库中，库是什么?库是一堆通用程序组件的集合，其他应用程序都需要使用其中的组件，库有很多好处，首先使用现成的组件可以实现程序的标准化，还有其他许多好处，使用库来开发的思路已经十分普及，库的种类和数量也很多，Socket也是一种库，包含的程序组件可让其他应用程序调用操作系统的网络功能，而解析器是库中的一种程序组件。

#### 1.2.4 使用解析器

- Socket库中的程序都是标准组件，只要从程序中直接调用即可
  - < 内存地址> = getostbyname('www.baidu.com');    怎样便完成了对解析器的调用，调用解析器后，它便会向DNS服务器发送查询消息，DNS服务器返回包含查询到的IP地址的响应消息，解析器取出IP地址并将其写入浏览器指定的内存地址中。

#### 1.2.5 解析器内部原理

- 网络应用程序(我们的场景就是浏览器)调用解析器时，程序的控制流程会转移到解析器内部。
- 控制流程转移:一般来算应用程序编写的操作内容是从上到下顺序执行的，到达需要调用解析器的部分时，对应的那一行程序就会被执行，应用程序本身工作会暂停，然后Socket中的解析器开始运行，完成应用程序委托的操作，将这样由于调用了其他程序原本运行的程序进入暂停状态，而被调用的程序开始运行，这就是控制流程转移。
- 当控制流程转移到解析器后，解析器生成要发送给DNS服务器的插叙你消息，解析器根据DNS规格，生成一条表示'请告诉我www.baidu.com的ip地址'的数据并发给DNS服务器，发送消息需要委托给操作系统内的协议栈执行，因为解析器和浏览器一样本身不具备使用网路收发数据的功能，解析器调用协议栈后，控制流程再次转移，协议栈执行发送消息的操作，通过网卡将消息发送给DNS服务器。
- DNS服务器收到查询消息后，根据消息中的查询内容进行查询。若要访问的Web服务器已经在DNS服务器上注册那么此记录就能被找到，其IP地址会被写入响应消息并返回给客户，接下来消息通过网络到达客户端，在经过协议栈被传递给解析器，然后解析器读取消息取出IP地址，并将IP地址传递给应用程序，实际上解析器会去除IP地址写入应用程序指定的内容地址中，用< 内存地址> 来表示。到这里，解析器任务完成了，控制流程重新返回应用程序，此时应用程序便能从内存中取出IP地址了。
- 需要注意的是向DNS服务器发送消息时也需要知道DNS服务器的IP地址，但此地址是作为TCP/IP的一个设置项目实现设置好了，无需查询，不同操作相同的TCP/IP设置方法有所差异。

### 1.3 DNS服务器接力

#### 1.3.1 DNS服务器基本工作

- DNS服务器基本工作是接收来自客户端的查询消息，然后根据消息内容返回响应，其中来自客户端的查询消息包含以下3种信息:
  - 域名:服务器、邮件服务器(@后的内容)的名称
  - Class:最早设计DNS方案时，DNS在互联网以外的其他网络中的应用也被考虑到了，而Class是用来识别网络的信息，不过如今除了互联网没有其他网络了，因此Class值永远是代表互联网的IN
  - 记录类型:表示域名对应何种类型的记录，类型为A时，表示域名对应的是IP地址，为MX时，域名对应的是邮件服务器，对于不同记录类型服务器向客户端返回的信息也不同。
- DNS服务器上事先保存着3种信息对应的记录数据，查找对应内容并返回。如查询www.baidu.com对应的IP地址，客户端会向DNS服务器发送包含以下信息的查询消息:
  - 域名 == www.baidu.com
  - Class = IN
  - 记录类型 = A
- 然后DNS服务器从已有记录中查询全部匹配的记录再返回响应数据即可。

#### 1.3.2 域名层次结构

- 互联网中存在许多服务器，把服务器请按不保存再一台DNS服务器是不可能的，实际上是将信息分布保存在多台DNS服务器中，这些DNS服务器相互接力配合，从而查找出要查询的信息，但这个机制有点复杂。
- 首先DNS服务器中所有信息是按照域名以分层次的结构来保存的，层级结构类似公司中的事业集团、部门、科室，它能帮助我更好的管理大量信息。
- DNS中的域名是通过句点分隔的，如www.baidu.com,句点代表不同层级之间的界限，相当于公司里面的部、科用句点来分隔，域名中越靠右的位置代表层级越高，如com事业集团，baidu部www科。
- 这种具有层次结构的域名信息会注册到DNS服务器中，而每个域都是作为一个整体来处理的，不能将一个域拆开来存放在多台DNS服务器中，但一台DNS服务器可存放多个域的信息，于是DNS服务器也具有了像域名一样的层级结构，每个域的信息都存放在相应层级的DNS服务器中。
- 对公司域来说，若需要为每个事业集团配备一台DNS服务器分别管理自己的信息，但域是不可分割的，此时需要在域的下面创建下级域然后将它们分别分配给各个事业集团

#### 1.3.3 寻找相应的DNS服务器并获取IP地址

- 互联网中有数万台DNS服务器，肯定不能一台一台挨个找，实际上是首先将负责管理下级域的DNS服务器的IP地址注册到它们的上级DNS服务器中，上级DNS服务器的IP地址在注册到更上一级，重复，eg:负责管理www.baidu.com这个域的DNS服务器的IP地址需要注册到baidu.com的DNS服务器中，baidu.com的服务器又需注册到com域的DNS服务器中，这样我们就可以通过上次DNS服务器查询出下级DNS服务器的IP地址，也就可以向下级DNS服务器发送查询请求了。
- com、jp这些顶级域并非最底层，其实上面还有一级域，称为根域，通常书写时被忽略，它是www.baidu.com.   最后的那个句点，不过一般都不写这个句点，因此根域通常被忽略，但根域是真实存在的，根域的DNS服务器保存着com、jp等DNS服务器的信息，由于上级DNS服务器保存着所有下级DNS服务器的信息，因此可从根域开始一路向下找到任意一个域的DNS服务器。
- 除此之外还需将根域的DNS服务器信息保存在互联网所有DNS服务器中，分配给根域DNS服务器的IP地址全球仅13个，这些地址几乎不变，因此将这些地址保存在所有DNS服务器也不是难事，实际上根域DNS服务器的相关信息已经包含在DNS服务器程序的配置文件中了，因此只要安装了DNS服务器程序，这些信息便会自动配置。

#### 1.3.4 通过缓存加快DNS服务器的响应

- 真实互联网中一台DNS服务器可管理多个域的信息，上级域和下级域可能共享同一台DNS服务器，这种情况下访问上级DNS服务器就可以向下跳过一级DNS服务器。
- 有时不需要从最上级根域开始查找，因为DNS服务器具有缓存功能，可以记住之前查询过的域名，若查询域名已在缓存中，就可以从缓存中得到所需信息，可以减少查询时间。并且当查询的域名不存在时，不存在这一响应结果也会被缓存，下次查询便可快速响应
- 缓存机制需要注意的是缓存中的信息可能是不正确的，因此DNS服务器保存的信息都设置有一个有效期，超过有效期后，数据就会从缓存中删除。在对查询响应时，DNS服务器也会告知客户端响应结果是来自缓存还是来自负责管理该域名的DNS服务器。

## 1.4 委托协议栈发送消息

#### 1.4.1 数据收发操作概览

- 知道IP地址后就可委托协议栈向目标IP地址发送消息了，发送的HTTP消息是一种数字信息，因此可说是委托协议栈发送数字信息，收发数字信息不局限于浏览器，各种使用网络的应用程序来说都是可以的，过程如下:
  - 类似向DNS服务器查询IP，这也需要使用Socket库中的程序组件，但查询IP仅需调用一个程序组件，而这里需要按照指定顺序调用多个程序组件，整体思路:
    - 收发数据的两台计算机之间连接了一条数据通道，数据沿着这条通道流动，最终到达目的地，数据流动是双向的，可从任何一段被取出或送入。
  - 管道并非一开始就有，双方需要先建立起这条管道，建立的关键在于管道两端的数据出入口，这些出入口称为套接字，我们需要先创建套接字，在连接套接字形成管道，实际过程如下:
    - 服务器一方先创建套接字，然后等待客户端向该套接字连接管道，当服务器进入等待状态，客户端就可以连接了，具体来说，客户端也会先创建一个套接字，然后从该套接字延伸出管道，最后管道连接到服务器端的套接字上。
    - 收发数据结束时，连接管道会断开，断开由任意一方都可发起，断开后，套接字删除，通信操作结束。
  - 综上，过程如下:
    1. 创建套接字
    2. 将管道连接到服务器端套接字上
    3. 收发数据(通信阶段)
    4. 断开管道并删除套接字。
- 每个阶段Socket库中的程序组件都会被调用来执行相关的数据收发操作，前面这4个阶段都是委托协议栈完成的，委托操作通过调用Socket库的程序组件执行，但这种组件仅充当桥梁校色，不执行任何实质性操作。

#### 1.4.2 创建套接字阶段

- 应用程序委托收发数据过程关键点就像对DNS服务器发送查询一样，调用Socket库中的特定程序组件，访问DNS服务器时调用的是gethostbyname(解析器)，而此时需要按一定顺序调用组件
  - 首先是调用socket组件，此时控制流程转移到socket内部并执行创建套接字的操作，完成后控制流程又会被转移回应用程序。
  - 套接字创建完成后，协议栈会返回一个描述符用于识别不同套接字，应用程序会将收到的描述符放在内存中。只要出示标识符，协议栈便能判断出我们希望用哪个套接字连接或收发数据了。

#### 1.4.3 连接阶段

- 接下来需要委托协议栈将客户端和服务器的套接字连接，此时调用Socket库中的名为connect组件，调用它需要指定3个参数:
  - 描述符
  - IP地址
  - 端口号，IP地址可用于找出具体的某台计算机，而端口号可用于明确识别这台计算机的某个具体的套接字。

#### 1.4.4 通信阶段:传递消息

- 套接字连接后，只需将数据送入套接字即可将数据发送到对方套接字，此操作通过Socket库的write组件完成，首先应用程序准备好要发送的数据，即根据用户输入的URL生成的HTTP消息，然后调用write，需要指定描述符和发送数据，接下来协议栈会将数据发送到服务器。
- 服务器执行接收操作，解析收到的数据内容并执行相应操作，在客户端返回响应消息。当消息返回后，需要执行接收消息的操作，通过read组件完成，调用read需要指定用于存放接收到的响应消息的内存地址，称为接收缓冲区，它是位于应用程序内部的内存空间，当消息放到接收缓冲区中时相当于已经转交给了应用程序。

#### 1.4.5 断开阶段:收发数据结束

- 浏览器收到数据后收发过程结束，接下来需要调用Socket库中的close程序进入断开阶段，最终连接在套件字间的管道断开，套接字删除。
- 断开过程如下:
  - Web使用的HTTP协议规定Web服务器发送完响应消息后，应主动执行断开操作，因此Web服务器首先调用close断开连接，断开操作传到客户端后，客户端套接字也断开，然后浏览器调用read执行接收数据操作时，read告知服务器收发数据操作结束，浏览器得知后也调用close断开。

## 1章小结

- 这便是HTTP工作过程，HTTP协议将HTML文档和图片当作单独对象处理，每获取依次数据就要执行一次全过程，重复断开和连接效率很低，因此后来人们设计出了能在一次连接中收发多个请求和响应的方法，HTTP1.1便可以使用此方法，这种情况下单当所有数据都请求完成后，浏览器会主动出发断开连接操作。
- 实际上负责收发操作的是协议栈、网卡驱动和网卡，这3者相互配合数据才能流动起来。

# 2.用电信号传输TCP/IP数据，探索协议栈和网卡

1. 创建套接字:介绍协议栈内部结构、套接字实体、创建套接字具体过程
2. 连接服务器:客户端套接字向服务器套接字连接的阶段。介绍连接具体是怎样的操作，此过程中协议栈如何工作，客户端服务器如何交互。
3. 收发数据：套接字连接后进入收发消息阶段。此阶段协议栈将从应用程序收到的数据切成小块并发送给服务器，考虑到通信过程可能会出错导致网络包丢失，协议栈需确认切分出的每个包是否已经送达服务器，对没有送达的包也要重新发送一次，这里对收发数据的情形加以说明。
4. 从服务器断开连接并删除套接字:收发消息操作结束后，接下来断开服务器连接并删除套接字，断开操作本质是当消息收发完成后客户端和服务器相互进行确认的过程，但这个过程并非相互确认并删除套接字那么简单。
5. IP与以太网的包收发操作:了解实际的网络包如何进行收发，协议栈会与网卡进行配合，将数据切分成小块并封装成网络包，再将网络包转换成电信号或光信号发送出去。了解这个过程便可对计算机网络功能有个完整的概念。
6. UDP协议收发数据的操作:TCP协议有很多方便的功能，如网络包出错丢失时可以重发，因此很多应用程序都是用TCP协议收发数据的，但这些方便的功能偶尔会帮倒忙，此时还有一种叫UDP的协议。

### 2.1 创建套接字

#### 2.1.1 协议栈内部结构

- 不像浏览器，协议栈工作从表面上是看不见的，其内部结构上半部分有两块，分别是负责用TCP协议收发数据的部分和负责用UDP协议收发数据的部分，它们会接受应用程序的委托执行收发数据操作。像浏览器、邮件一般的应用程序都是用TCP收发数据的，而像DNS查询等收发较短的控制数据则使用UDP。
- 下半部分是用IP协议控制网络包收发操作的部分，在互联网上传送数据时，数据会被切分成一个个网络包，将网络包发给通信对象的操作是由IP负责的，IP还包括ICMP协议和ARP协议，ICMP用于告知网络包传送过程中产生的错误以及各种控制消息，ARP用于根据IP地址查询相应的以太网MAC地址。

#### 2.1.2 套接字的实体就是通信控制信息

- 协议栈内部有一块用于存放控制信息的内存空间记录了用于控制通信操作的控制信息，如通信对象的IP地址、端口号、通信操作的进行状态等，套接字是一个概念并非实体，若非要赋予其实体，这些控制信息就是套接字实体，或说存放控制信息的内存空间就是套接字的实体。
- 协议栈执行操作时需要参阅这些控制信息(它相当于备忘录和日程表，告诉我们下一步该干嘛)，如发送数据时需要看一看套接字中的通信对象IP地址和端口号，以便向指定的IP地址和端口发送数据，发送数据后协议栈需要等待对方返回收到数据的响应信息，但数据可能丢失导致永远得不到响应，因此协议栈需要知道执行发送操作后过了多久，为此套接字必须记录是否已经收到响应以及发送数据过了多久，才能根据这些信息按照需要执行重发操作。
- 综上，套接字记录了控制通信操作的各种控制信息，协议栈则需要根据这些信息判断下一步行动，这就是套接字的作用。

#### 2.1.3 调用socket时的操作

- 浏览器通过Socket库向协议栈发出委托的一系列操作(TCP):
  - 先是创建套接字阶段，应用程序调用socket申请创建套接字，协议栈根据应用程序申请执行创建套接字操作。
  - 此过程中协议栈先分配用于存放一个套接字所需的内存空间，这个内存空间并非一开始就存在，而是需要我们先开辟出这样一块空间，相当于为控制信息准备一个容器，套接字刚创建时数据收发操作还未开始，因此需要在套接字内存空间写入表示这一初始状态的控制信息，到此，创建套接字操作完成。
  - 计算机内部会同时运行多个程序，若每个程序都擅自使用内存空间会发送多个程序重复使用一个内存区域导致数据损坏的情况，为此，操作系统有一个名为内存管理的模块负责根据程序的申请分配响应的内存空间并确保这些内存空间不会被其他程序使用。因此分配内存的操作就是向内存管理模块提出申请，请它分一块内存空间出来。
  - 接下来将套接字的描述符告诉应用程序，然后应用程序在向协议栈进行收发数据委托时提供这个描述符，协议栈通过它获取了套接字的所有信息，因此应用程序不需要每次都告诉协议栈该和谁通信。

### 2.2 连接服务器

#### 2.2.1 连接

- 创建套接字后，应用程序就会调用connect,随后协议栈会将本地的套接字与服务器的套接字进行连接。执行数据收发操作时，还需一块用来临时存放要收发数据的内存空间，称为缓冲区，它是连接操作过程中分配的。

#### 2.2.2 负责控制信息的头部

- 控制信息分为两类:头部中记录的信息和套接字中记录的信息
